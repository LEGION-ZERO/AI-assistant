<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linux æ™ºèƒ½è¿ç»´åŠ©æ‰‹</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4f;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --success: #3fb950;
      --panel: #161b22;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Sans SC", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
    }
    .subtitle {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    .input-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .input-row input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }
    .input-row input::placeholder { color: var(--muted); }
    .input-row input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
    }
    .btn {
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { background: #79b8ff; }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-danger {
      background: #da3633;
      color: #fff;
    }
    .btn-danger:hover { background: #f85149; }
    .btn-danger:disabled { opacity: 0.6; cursor: not-allowed; }
    .section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .section-title {
      padding: 0.6rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }
    .section-body {
      padding: 1rem;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .section-body.empty { color: var(--muted); }
    .cmd-block {
      margin-bottom: 1rem;
      border-left: 3px solid var(--accent);
      padding-left: 1rem;
    }
    .cmd-block:last-child { margin-bottom: 0; }
    .cmd-block .asset { font-weight: 600; color: var(--accent); margin-bottom: 0.25rem; }
    .cmd-block .cmd { font-family: "JetBrains Mono", monospace; color: var(--muted); font-size: 0.85rem; margin-bottom: 0.5rem; }
    .cmd-block .result { font-family: "JetBrains Mono", monospace; font-size: 0.85rem; white-space: pre-wrap; }
    .reply-body { white-space: pre-wrap; }
    #reply .reply-table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; font-size: 0.9rem; }
    #reply .reply-table th, #reply .reply-table td { border: 1px solid var(--border); padding: 0.4rem 0.6rem; text-align: left; }
    #reply .reply-table th { background: var(--panel); color: var(--accent); font-weight: 600; }
    #reply .reply-table tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    .error {
      background: rgba(248, 81, 73, 0.1);
      border-color: #f85149;
      color: #f85149;
    }
    .loading { opacity: 0.7; pointer-events: none; }
    .loading #stopBtn { pointer-events: auto; }
    .cmd-block.pending .result { color: var(--muted); }
    .cmd-block.pending .result::after { content: " â–‹"; animation: blink 0.8s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    #commands:not(.empty) { max-height: 50vh; overflow-y: auto; }
    .nav {
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    .nav a { color: var(--muted); text-decoration: none; }
    .nav a:hover, .nav a.active { color: var(--accent); }
    .result-hidden { display: none !important; }
    .form-row { margin-bottom: 1rem; }
    .form-row label { display: block; margin-bottom: 0.35rem; color: var(--muted); font-size: 0.85rem; }
    .form-row select {
      width: 100%;
      max-width: 280px;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }
    .form-row select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(88,166,255,0.2);
    }
    .form-group label { display: block; margin-bottom: 0.35rem; color: var(--muted); font-size: 0.85rem; }
    .form-group input, .form-group select {
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }
    .input-row { align-items: flex-end; }
  </style>
</head>
<body>
  <nav class="nav">
    <a href="/" class="active">é¦–é¡µ</a>
    <a href="/assets">èµ„äº§ç®¡ç†</a>
  </nav>
  <div class="container">
    <h1>Linux æ™ºèƒ½è¿ç»´åŠ©æ‰‹</h1>
    <p class="subtitle">é€‰æ‹©è¿ç»´å¯¹è±¡ï¼ˆå¯é€‰ï¼‰ï¼Œè¾“å…¥è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œç”± AI è§„åˆ’å¹¶åœ¨ Linux èµ„äº§ä¸Šæ‰§è¡Œï¼ˆå·¡æ£€ã€éƒ¨ç½²ç­‰ï¼‰ï¼Œæ‰§è¡Œè¿‡ç¨‹å®æ—¶æ˜¾ç¤º</p>

    <div class="form-row">
      <label for="assetSelect">è¿ç»´å¯¹è±¡</label>
      <select id="assetSelect">
        <option value="">ä¸æŒ‡å®šï¼ˆç”± AI æ ¹æ®æŒ‡ä»¤é€‰æ‹©ï¼‰</option>
        <option value="__all__">å…¨éƒ¨èµ„äº§</option>
        <!-- ç”± JS æ‹‰å– /api/assets åå¡«å…… -->
      </select>
    </div>

    <div class="input-row">
      <input
        type="text"
        id="instruction"
        placeholder="ä¾‹å¦‚ï¼šåšä¸€æ¬¡å·¡æ£€ / æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ"
        autocomplete="off"
      />
      <button type="button" class="btn btn-primary" id="submit">æ‰§è¡Œ</button>
      <button type="button" class="btn btn-danger" id="stopBtn" disabled title="åœæ­¢å½“å‰æ‰§è¡Œï¼ˆä¸‹ä¸€è½®å‘½ä»¤å‰ç”Ÿæ•ˆï¼‰">åœæ­¢</button>
    </div>

    <div class="section result-hidden" id="commands-section">
      <div class="section-title">æ‰§è¡Œè¿‡ç¨‹</div>
      <div class="section-body empty" id="commands">æš‚æ— æ‰§è¡Œè®°å½•</div>
    </div>

    <div class="section result-hidden" id="model-thinking-section">
      <div class="section-title">æ¨¡å‹æ€è€ƒ / æ¯è½®è¾“å‡º</div>
      <div class="section-body empty" id="model-thinking">æ— ï¼ˆè‡ªç ” Agent/åŸç”Ÿ tools æ¨¡å¼ä¸‹æ­¤å¤„ä¸æ˜¾ç¤ºï¼‰</div>
    </div>

    <div class="section result-hidden" id="reply-section">
      <div class="section-title">åŠ©æ‰‹å›å¤</div>
      <div class="section-body empty" id="reply">ç­‰å¾…æ‰§è¡Œåæ˜¾ç¤º</div>
    </div>
  </div>

  <script>
    const instructionEl = document.getElementById("instruction");
    const submitBtn = document.getElementById("submit");
    const stopBtn = document.getElementById("stopBtn");
    const assetSelect = document.getElementById("assetSelect");
    const commandsEl = document.getElementById("commands");
    const modelThinkingEl = document.getElementById("model-thinking");
    const modelThinkingSection = document.getElementById("model-thinking-section");
    const replyEl = document.getElementById("reply");
    const replySection = document.getElementById("reply-section");

    let assetList = [];

    async function loadAssets() {
      try {
        const res = await fetch("/api/assets");
        const list = await res.json();
        assetList = list || [];
        const sel = assetSelect;
        while (sel.options.length > 2) sel.remove(2);
        assetList.forEach(a => {
          const opt = document.createElement("option");
          opt.value = a.name;
          opt.textContent = a.name + " (" + a.host + ")";
          sel.appendChild(opt);
        });
      } catch (_) {}
    }
    loadAssets();

    let currentTraceId = null;

    function setLoading(loading) {
      submitBtn.disabled = loading;
      stopBtn.disabled = !loading;
      if (loading) document.body.classList.add("loading");
      else {
        document.body.classList.remove("loading");
        currentTraceId = null;
      }
    }

    function showError(msg) {
      replyEl.textContent = msg;
      replyEl.classList.remove("empty");
      replySection.classList.add("error");
    }

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    /** å°†åŠ©æ‰‹å›å¤ä¸­çš„ Markdown è¡¨æ ¼è½¬ä¸º HTML è¡¨æ ¼ï¼Œå…¶ä½™ä¸ºè½¬ä¹‰æ–‡æœ¬+æ¢è¡Œ */
    function formatReplyWithTables(text) {
      if (!text || !text.trim()) return "";
      const lines = text.split("\n");
      const out = [];
      let i = 0;
      while (i < lines.length) {
        const line = lines[i];
        if (line.trim().startsWith("|")) {
          const tableLines = [];
          while (i < lines.length && lines[i].trim().startsWith("|")) {
            tableLines.push(lines[i]);
            i++;
          }
          const rows = tableLines.map((l) =>
            l.split("|").slice(1, -1).map((c) => c.trim())
          );
          if (rows.length === 0) continue;
          const isSep = (row) => row.every((c) => /^[-:\s]+$/.test(c));
          const header = rows[0];
          const bodyStart = rows.length > 1 && isSep(rows[1]) ? 2 : 1;
          let html = '<table class="reply-table"><thead><tr>';
          header.forEach((cell) => { html += "<th>" + escapeHtml(cell) + "</th>"; });
          html += "</tr></thead><tbody>";
          for (let r = bodyStart; r < rows.length; r++) {
            html += "<tr>";
            rows[r].forEach((cell) => { html += "<td>" + escapeHtml(cell) + "</td>"; });
            html += "</tr>";
          }
          html += "</tbody></table>";
          out.push(html);
        } else {
          out.push(escapeHtml(line));
          i++;
        }
      }
      return out.join("<br>");
    }

    /** å‘½ä»¤å¼€å§‹ï¼šç«‹å³æ˜¾ç¤ºã€Œæ‰§è¡Œä¸­â€¦ã€ï¼ˆé¡ºåºä¸åç«¯ä¸€è‡´ï¼Œç”¨ç¬¬ä¸€ä¸ª pending åŒ¹é…ç»“æœï¼‰ */
    function appendCommandStart(asset_name, command) {
      commandsEl.classList.remove("empty");
      const block = document.createElement("div");
      block.className = "cmd-block pending";
      block.innerHTML = `
        <div class="asset">ğŸ–¥ ${escapeHtml(asset_name)}</div>
        <div class="cmd">$ ${escapeHtml(command)}</div>
        <div class="result">æ‰§è¡Œä¸­â€¦</div>
      `;
      commandsEl.appendChild(block);
      block.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    /** æ— å·¥å…·æ¨¡å¼ï¼šè¿½åŠ æ¨¡å‹æœ¬è½®è¾“å‡ºï¼ˆæ¨¡å‹æ€è€ƒè¿‡ç¨‹ï¼‰ */
    function appendModelReply(round, content) {
      modelThinkingSection.classList.remove("result-hidden");
      modelThinkingEl.classList.remove("empty");
      const block = document.createElement("div");
      block.className = "model-reply-block";
      block.style.marginTop = "0.75rem";
      block.style.padding = "0.5rem 0";
      block.style.borderTop = "1px solid var(--border)";
      block.innerHTML = `<div style="color:var(--muted);font-size:0.85rem;">ç¬¬ ${round} è½®æ¨¡å‹è¾“å‡º</div><pre class="reply-body" style="margin:0.25rem 0 0;white-space:pre-wrap;word-break:break-all;">${escapeHtml((content || "").trim())}</pre>`;
      modelThinkingEl.appendChild(block);
      block.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    /** å‘½ä»¤ç»“æŸï¼šæ›´æ–°å½“å‰ç¬¬ä¸€ä¸ªã€Œæ‰§è¡Œä¸­ã€å—ä¸ºå®é™…ç»“æœ */
    function updateCommandResult(c) {
      const block = commandsEl.querySelector(".cmd-block.pending");
      if (!block) return;
      const resultEl = block.querySelector(".result");
      if (resultEl) {
        resultEl.textContent = c.result;
        block.classList.remove("pending");
      }
      block.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    /** è§£æ SSE æµï¼šæŒ‰äº‹ä»¶å—ï¼ˆåŒæ¢è¡Œï¼‰å¤„ç†ï¼Œé¿å…é•¿ data è¢«åˆ†ç‰‡æˆªæ–­ */
    async function consumeSSE(res, onEvent) {
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const blocks = buffer.split("\n\n");
        buffer = blocks.pop() || "";

        for (const block of blocks) {
          let eventType = null;
          let dataStr = null;
          for (const line of block.split("\n")) {
            if (line.startsWith("event:")) eventType = line.slice(6).trim();
            else if (line.startsWith("data:")) dataStr = line.slice(5);
          }
          if (eventType && dataStr != null) {
            try {
              const data = JSON.parse(dataStr);
              onEvent(eventType, data);
            } catch (_) {}
          }
        }
      }
    }

    submitBtn.addEventListener("click", async () => {
      const instruction = instructionEl.value.trim();
      if (!instruction) return;

      document.getElementById("commands-section").classList.remove("result-hidden");
      document.getElementById("model-thinking-section").classList.remove("result-hidden");
      document.getElementById("reply-section").classList.remove("result-hidden");

      setLoading(true);
      commandsEl.innerHTML = "æ­£åœ¨æ‰§è¡Œâ€¦";
      commandsEl.classList.remove("empty");
      modelThinkingEl.innerHTML = "ç­‰å¾…æ¨¡å‹è¾“å‡ºâ€¦";
      modelThinkingEl.classList.remove("empty");
      replyEl.textContent = "ç­‰å¾…ä¸­â€¦";
      replyEl.classList.remove("empty");
      replySection.classList.remove("error");

      const selValue = assetSelect.value;
      let asset_names = null;
      if (selValue === "__all__" && assetList.length) asset_names = assetList.map(a => a.name);
      else if (selValue && selValue !== "__all__") asset_names = [selValue];

      try {
        const res = await fetch("/api/run/stream", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ instruction, asset_names }),
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          showError(data.detail || res.statusText || "è¯·æ±‚å¤±è´¥");
          commandsEl.innerHTML = "æš‚æ— æ‰§è¡Œè®°å½•";
          commandsEl.classList.add("empty");
          return;
        }

        commandsEl.innerHTML = "";

        await consumeSSE(res, (eventType, data) => {
          if (eventType === "start" && data.trace_id) {
            currentTraceId = data.trace_id;
          } else if (eventType === "command_start") {
            appendCommandStart(data.asset_name, data.command);
          } else if (eventType === "command") {
            updateCommandResult(data);
          } else if (eventType === "model_reply") {
            appendModelReply(data.round || 1, data.content || "");
          } else if (eventType === "reply") {
            replyEl.innerHTML = formatReplyWithTables(data.reply || "");
            replyEl.classList.remove("empty");
            replySection.classList.remove("error");
            if (!modelThinkingEl.querySelector(".model-reply-block")) {
              modelThinkingEl.innerHTML = "æ— ï¼ˆæœ¬æ¬¡æœªä½¿ç”¨æ— å·¥å…·å¤šè½®æ¨¡å¼ï¼‰";
              modelThinkingEl.classList.add("empty");
            }
          } else if (eventType === "error") {
            showError(data.detail || "æ‰§è¡Œå‡ºé”™");
          }
        });

        if (commandsEl.querySelectorAll(".cmd-block").length === 0) {
          commandsEl.innerHTML = "æš‚æ— æ‰§è¡Œè®°å½•";
          commandsEl.classList.add("empty");
        }
      } catch (e) {
        showError("ç½‘ç»œé”™è¯¯: " + e.message);
        commandsEl.innerHTML = "æš‚æ— æ‰§è¡Œè®°å½•";
        commandsEl.classList.add("empty");
      } finally {
        setLoading(false);
      }
    });

    instructionEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitBtn.click();
    });

    stopBtn.addEventListener("click", async () => {
      if (!currentTraceId) return;
      try {
        const res = await fetch("/api/run/stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ trace_id: currentTraceId }),
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.ok) {
          stopBtn.disabled = true;
        }
      } catch (_) {}
    });
  </script>
</body>
</html>
